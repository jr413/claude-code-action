name: Standalone Code Generator (OAuth)

on:
  workflow_dispatch:
    inputs:
      project_type:
        description: 'Type of project to generate'
        required: true
        default: 'todo-app'
        type: choice
        options:
          - 'todo-app'
          - 'ecommerce'
          - 'blog'
          - 'dashboard'
      tech_stack:
        description: 'Technology stack'
        required: true
        default: 'react-node'
        type: choice
        options:
          - 'react-node'
          - 'vue-python'
          - 'svelte-rust'
          - 'next-prisma'

jobs:
  generate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: |
        npm install -g bun
        bun install || npm install
        
    - name: Read input files
      id: read-inputs
      run: |
        # Create temporary files to avoid GitHub Actions output issues
        mkdir -p temp
        
        if [ -f "input/â‘ è¦ä»¶å®šç¾©.md" ]; then
          cp "input/â‘ è¦ä»¶å®šç¾©.md" temp/requirements.md
          echo "requirements_file=temp/requirements.md" >> $GITHUB_OUTPUT
          echo "âœ… Requirements file found"
        else
          echo "âš ï¸ Requirements file not found"
        fi
        
        if [ -f "input/â‘¡æŠ€è¡“å®šç¾©.yaml" ]; then
          cp "input/â‘¡æŠ€è¡“å®šç¾©.yaml" temp/tech-spec.yaml
          echo "tech_spec_file=temp/tech-spec.yaml" >> $GITHUB_OUTPUT
          echo "âœ… Tech spec file found"
        else
          echo "âš ï¸ Tech spec file not found"
        fi
        
        if [ -f "input/â‘¢v0ãƒ¢ãƒƒã‚¯ã‚¢ãƒƒãƒ—" ]; then
          cp "input/â‘¢v0ãƒ¢ãƒƒã‚¯ã‚¢ãƒƒãƒ—" temp/mockup.md
          echo "mockup_file=temp/mockup.md" >> $GITHUB_OUTPUT
          echo "âœ… Mockup file found"
        else
          echo "âš ï¸ Mockup file not found"
        fi

    - name: Generate project with Claude (OAuth)
      env:
        CLAUDE_CLIENT_ID: ${{ secrets.CLAUDE_CLIENT_ID }}
        CLAUDE_CLIENT_SECRET: ${{ secrets.CLAUDE_CLIENT_SECRET }}
      run: |
        mkdir -p output
        
        # Read input files
        REQUIREMENTS=""
        TECH_SPEC=""
        MOCKUP=""
        
        if [ -f "temp/requirements.md" ]; then
          REQUIREMENTS=$(cat temp/requirements.md)
          echo "ğŸ“‹ Requirements loaded"
        fi
        
        if [ -f "temp/tech-spec.yaml" ]; then
          TECH_SPEC=$(cat temp/tech-spec.yaml)
          echo "âš™ï¸ Tech spec loaded"
        fi
        
        if [ -f "temp/mockup.md" ]; then
          MOCKUP=$(cat temp/mockup.md)
          echo "ğŸ¨ Mockup loaded"
        fi
        
        # Function to get fresh OAuth token
        get_oauth_token() {
          echo "ğŸ” Getting fresh OAuth token..."
          
          # Try client_credentials grant
          TOKEN_RESPONSE=$(curl -s -w "HTTP_STATUS:%{http_code}" -X POST "https://api.anthropic.com/v1/oauth/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=client_credentials&client_id=$CLAUDE_CLIENT_ID&client_secret=$CLAUDE_CLIENT_SECRET")
          
          # Extract HTTP status and response body
          HTTP_STATUS=$(echo "$TOKEN_RESPONSE" | grep -o "HTTP_STATUS:[0-9]*" | cut -d: -f2)
          RESPONSE_BODY=$(echo "$TOKEN_RESPONSE" | sed 's/HTTP_STATUS:[0-9]*$//')
          
          echo "OAuth HTTP Status: $HTTP_STATUS"
          echo "OAuth Response: $RESPONSE_BODY"
          
          if [ "$HTTP_STATUS" = "200" ]; then
            ACCESS_TOKEN=$(echo "$RESPONSE_BODY" | jq -r '.access_token // empty')
            
            if [ -n "$ACCESS_TOKEN" ] && [ "$ACCESS_TOKEN" != "null" ]; then
              echo "âœ… OAuth token obtained successfully"
              return 0
            fi
          fi
          
          echo "âŒ Failed to get OAuth token"
          return 1
        }
        
        # Function to call Claude API with retry logic
        call_claude_api() {
          local attempt=1
          local max_attempts=3
          
          while [ $attempt -le $max_attempts ]; do
            echo "ğŸ¤– Calling Claude API (attempt $attempt/$max_attempts)..."
            
            if get_oauth_token; then
              # Create prompt for Claude
              cat > prompt.txt << 'PROMPT_EOF'
Based on these requirements, generate a complete ${{ github.event.inputs.project_type }} project with ${{ github.event.inputs.tech_stack }} tech stack.

Please provide a complete project structure with all necessary files. Format your response with clear file separators like:

=== filename.ext ===
[file content]
=== END ===

Requirements:
PROMPT_EOF
              
              echo "$REQUIREMENTS" >> prompt.txt
              echo -e "\n\nTech Spec:" >> prompt.txt
              echo "$TECH_SPEC" >> prompt.txt
              echo -e "\n\nMockup:" >> prompt.txt
              echo "$MOCKUP" >> prompt.txt
              echo -e "\n\nGenerate complete project structure with all necessary files including package.json, Dockerfile, source code, and documentation." >> prompt.txt
              
              # Call Claude API with OAuth token
              HTTP_RESPONSE=$(curl -s -w "HTTP_STATUS:%{http_code}" -X POST "https://api.anthropic.com/v1/messages" \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $ACCESS_TOKEN" \
                -H "anthropic-version: 2023-06-01" \
                -d @- << 'API_EOF'
{
  "model": "claude-3-sonnet-20240229",
  "max_tokens": 8000,
  "messages": [{
    "role": "user",
    "content": "$(cat prompt.txt | jq -Rs .)"
  }]
}
API_EOF
              )
              
              # Extract HTTP status and response body
              HTTP_STATUS=$(echo "$HTTP_RESPONSE" | grep -o "HTTP_STATUS:[0-9]*" | cut -d: -f2)
              RESPONSE_BODY=$(echo "$HTTP_RESPONSE" | sed 's/HTTP_STATUS:[0-9]*$//')
              
              echo "Claude API HTTP Status: $HTTP_STATUS"
              
              # Save response to file
              echo "$RESPONSE_BODY" > claude_response.json
              
              if [ "$HTTP_STATUS" = "200" ]; then
                # Check for API errors in response
                if echo "$RESPONSE_BODY" | jq -e '.error' > /dev/null 2>&1; then
                  echo "âŒ Claude API returned error:"
                  echo "$RESPONSE_BODY" | jq '.error'
                  attempt=$((attempt + 1))
                  sleep 5
                  continue
                fi
                
                echo "âœ… Claude API call successful"
                return 0
              elif [ "$HTTP_STATUS" = "401" ]; then
                echo "âŒ Authentication failed (401), retrying with fresh token..."
                attempt=$((attempt + 1))
                sleep 5
                continue
              else
                echo "âŒ API call failed with status $HTTP_STATUS"
                echo "Response: $RESPONSE_BODY"
                attempt=$((attempt + 1))
                sleep 5
                continue
              fi
            else
              echo "âŒ Failed to get OAuth token"
              attempt=$((attempt + 1))
              sleep 5
            fi
          done
          
          echo "âŒ All OAuth attempts failed"
          return 1
        }
        
        # Execute Claude API call with retry logic
        if call_claude_api; then
          echo "âœ… Successfully got response from Claude"
          
          # Extract and create files from Claude response
          if [ -f "claude_response.json" ] && jq -e '.content[0].text' claude_response.json > /dev/null 2>&1; then
            node -e "
              const fs = require('fs');
              try {
                const response = JSON.parse(fs.readFileSync('claude_response.json'));
                const content = response.content[0].text;
                console.log('Claude response received:', content.substring(0, 200) + '...');
                
                // Extract files using === filename === pattern
                const filePattern = /=== ([^=]+) ===\n([\s\S]*?)\n=== END ===/g;
                let match;
                let fileCount = 0;
                
                while ((match = filePattern.exec(content)) !== null) {
                  const filename = match[1].trim();
                  const fileContent = match[2];
                  
                  const fullPath = \`output/\${filename}\`;
                  const dir = fullPath.split('/').slice(0, -1).join('/');
                  
                  if (dir && dir !== 'output') {
                    fs.mkdirSync(dir, { recursive: true });
                  }
                  
                  fs.writeFileSync(fullPath, fileContent);
                  console.log(\`Created: \${fullPath}\`);
                  fileCount++;
                }
                
                if (fileCount > 0) {
                  console.log(\`âœ… Total files created from Claude: \${fileCount}\`);
                } else {
                  console.log('âš ï¸ No files extracted from Claude response');
                  throw new Error('No files found in Claude response');
                }
              } catch (error) {
                console.error('Error processing Claude response:', error);
                throw error;
              }
            " || {
              echo "âŒ Failed to extract files from Claude response, using fallback"
              FALLBACK_NEEDED=true
            }
          else
            echo "âŒ Invalid Claude response format, using fallback"
            FALLBACK_NEEDED=true
          fi
        else
          echo "âŒ Failed to get response from Claude, using fallback"
          FALLBACK_NEEDED=true
        fi
        
        # Create minimal project structure as fallback if needed
        if [ "$FALLBACK_NEEDED" = "true" ] || [ ! -f "output/package.json" ]; then
          echo "ğŸ”„ Creating fallback React Todo app..."
          
          mkdir -p output/src output/public
          
          cat > output/package.json << 'PKG_EOF'
{
  "name": "simple-todo-app",
  "version": "1.0.0",
  "private": true,
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-scripts": "5.0.1"
  },
  "scripts": {
    "start": "react-scripts start",
    "build": "react-scripts build",
    "test": "react-scripts test",
    "eject": "react-scripts eject"
  },
  "eslintConfig": {
    "extends": [
      "react-app",
      "react-app/jest"
    ]
  },
  "browserslist": {
    "production": [
      ">0.2%",
      "not dead",
      "not op_mini all"
    ],
    "development": [
      "last 1 chrome version",
      "last 1 firefox version",
      "last 1 safari version"
    ]
  }
}
PKG_EOF
          
          cat > output/src/App.js << 'APP_EOF'
import React, { useState } from 'react';
import './App.css';

function App() {
  const [todos, setTodos] = useState([]);
  const [input, setInput] = useState('');

  const addTodo = () => {
    if (input.trim()) {
      setTodos([...todos, { id: Date.now(), text: input, completed: false }]);
      setInput('');
    }
  };

  const toggleTodo = (id) => {
    setTodos(todos.map(todo => 
      todo.id === id ? { ...todo, completed: !todo.completed } : todo
    ));
  };

  const deleteTodo = (id) => {
    setTodos(todos.filter(todo => todo.id !== id));
  };

  return (
    <div className="App">
      <header className="App-header">
        <h1>ğŸ—‚ï¸ My Todo App</h1>
      </header>
      <main className="App-main">
        <div className="todo-input">
          <input
            type="text"
            value={input}
            onChange={(e) => setInput(e.target.value)}
            onKeyPress={(e) => e.key === 'Enter' && addTodo()}
            placeholder="â• æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ..."
          />
          <button onClick={addTodo}>è¿½åŠ </button>
        </div>
        <div className="todo-stats">
          <span>ğŸ“Š åˆè¨ˆ: {todos.length}ã‚¿ã‚¹ã‚¯ | æœªå®Œäº†: {todos.filter(t => !t.completed).length} | å®Œäº†: {todos.filter(t => t.completed).length}</span>
        </div>
        <ul className="todo-list">
          {todos.map(todo => (
            <li key={todo.id} className={todo.completed ? 'completed' : ''}>
              <input
                type="checkbox"
                checked={todo.completed}
                onChange={() => toggleTodo(todo.id)}
              />
              <span className="todo-text">{todo.text}</span>
              <button onClick={() => deleteTodo(todo.id)} className="delete-btn">å‰Šé™¤</button>
            </li>
          ))}
        </ul>
        {todos.length === 0 && (
          <div className="empty-state">
            <p>ğŸ“ ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä¸Šè¨˜ã‹ã‚‰æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>
          </div>
        )}
      </main>
    </div>
  );
}

export default App;
APP_EOF
          
          cat > output/src/App.css << 'CSS_EOF'
        .App {
          max-width: 800px;
          margin: 0 auto;
          padding: 20px;
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
          min-height: 100vh;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .App-header {
          text-align: center;
          margin-bottom: 30px;
        }

        .App-header h1 {
          color: white;
          font-size: 2.5rem;
          margin: 0;
          text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .App-main {
          background: white;
          border-radius: 12px;
          padding: 30px;
          box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .todo-input {
          display: flex;
          gap: 12px;
          margin-bottom: 20px;
        }

        .todo-input input {
          flex: 1;
          padding: 14px 16px;
          border: 2px solid #e2e8f0;
          border-radius: 8px;
          font-size: 16px;
          transition: border-color 0.3s ease;
        }

        .todo-input input:focus {
          outline: none;
          border-color: #667eea;
          box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .todo-input button {
          padding: 14px 24px;
          background: #667eea;
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: background-color 0.3s ease;
        }

        .todo-input button:hover {
          background: #5a67d8;
        }

        .todo-stats {
          background: #f7fafc;
          padding: 12px 16px;
          border-radius: 8px;
          margin-bottom: 20px;
          font-size: 14px;
          color: #4a5568;
          border-left: 4px solid #667eea;
        }

        .todo-list {
          list-style: none;
          padding: 0;
          margin: 0;
        }

        .todo-list li {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 16px;
          border: 1px solid #e2e8f0;
          margin-bottom: 8px;
          border-radius: 8px;
          background: #fafafa;
          transition: all 0.3s ease;
        }

        .todo-list li:hover {
          background: #f0f4f8;
          transform: translateY(-1px);
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .todo-list li.completed {
          opacity: 0.7;
          background: #f0fff4;
          border-color: #9ae6b4;
        }

        .todo-list li.completed .todo-text {
          text-decoration: line-through;
          color: #68d391;
        }

        .todo-text {
          flex: 1;
          font-size: 16px;
          line-height: 1.5;
        }

        .delete-btn {
          background: #e53e3e;
          color: white;
          border: none;
          padding: 8px 16px;
          border-radius: 6px;
          font-size: 14px;
          cursor: pointer;
          transition: background-color 0.3s ease;
        }

        .delete-btn:hover {
          background: #c53030;
        }

        .empty-state {
          text-align: center;
          padding: 40px 20px;
          color: #718096;
          font-size: 16px;
        }

        input[type="checkbox"] {
          width: 20px;
          height: 20px;
          cursor: pointer;
        }
CSS_EOF
          
          cat > output/src/index.js << 'INDEX_EOF'
        import React from 'react';
        import ReactDOM from 'react-dom/client';
        import './index.css';
        import App from './App';

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
          <React.StrictMode>
            <App />
          </React.StrictMode>
        );
INDEX_EOF
          
          cat > output/src/index.css << 'ICSS_EOF'
        * {
          box-sizing: border-box;
        }

        body {
          margin: 0;
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
            'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
            sans-serif;
          -webkit-font-smoothing: antialiased;
          -moz-osx-font-smoothing: grayscale;
          background-color: #f7fafc;
        }

        code {
          font-family: source-code-pro, Menlo, Monaco, Consolas, 'Courier New',
            monospace;
        }
ICSS_EOF
          
          cat > output/public/index.html << 'HTML_EOF'
        <!DOCTYPE html>
        <html lang="ja">
          <head>
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1" />
            <meta name="theme-color" content="#667eea" />
            <meta name="description" content="ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¿ã‚¹ã‚¯ç®¡ç†ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³" />
            <title>ğŸ—‚ï¸ My Todo App</title>
          </head>
          <body>
            <noscript>JavaScriptã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚</noscript>
            <div id="root"></div>
          </body>
        </html>
HTML_EOF
          
          cat > output/Dockerfile << 'DOCKER_EOF'
        # Build stage
        FROM node:18-alpine as build

        WORKDIR /app
        COPY package*.json ./
        RUN npm ci --only=production

        COPY public ./public
        COPY src ./src
        RUN npm run build

        # Production stage
        FROM nginx:alpine

        COPY --from=build /app/build /usr/share/nginx/html
        COPY nginx.conf /etc/nginx/nginx.conf

        EXPOSE 80

        CMD ["nginx", "-g", "daemon off;"]
DOCKER_EOF
          
          cat > output/nginx.conf << 'NGINX_EOF'
        events {
            worker_connections 1024;
        }

        http {
            include       /etc/nginx/mime.types;
            default_type  application/octet-stream;
            
            sendfile        on;
            keepalive_timeout  65;

            server {
                listen       80;
                server_name  localhost;
                root   /usr/share/nginx/html;
                index  index.html index.htm;

                location / {
                    try_files $uri $uri/ /index.html;
                }

                location /static/ {
                    expires 1y;
                    add_header Cache-Control "public, immutable";
                }
            }
        }
NGINX_EOF
          
          cat > output/README.md << 'README_EOF'
        # ğŸ—‚ï¸ Simple Todo App

        ã‚·ãƒ³ãƒ—ãƒ«ã§ç¾ã—ã„ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

        ## âœ¨ æ©Ÿèƒ½

        - âœ… ã‚¿ã‚¹ã‚¯ã®è¿½åŠ ãƒ»å‰Šé™¤ãƒ»ç·¨é›†
        - ğŸ”„ ã‚¿ã‚¹ã‚¯ã®å®Œäº†çŠ¶æ…‹ç®¡ç†
        - ğŸ“Š ã‚¿ã‚¹ã‚¯çµ±è¨ˆã®è¡¨ç¤º
        - ğŸ¨ ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³
        - ğŸŒˆ ç¾ã—ã„ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ UI

        ## ğŸš€ ä½¿ã„æ–¹

        ### é–‹ç™ºç’°å¢ƒã§ã®å®Ÿè¡Œ

        ```bash
        npm install
        npm start
        ```

        ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://localhost:3000 ã‚’é–‹ãã¾ã™ã€‚

        ### æœ¬ç•ªãƒ“ãƒ«ãƒ‰

        ```bash
        npm run build
        ```

        ### Docker ã§ã®å®Ÿè¡Œ

        ```bash
        docker build -t todo-app .
        docker run -p 80:80 todo-app
        ```

        ## ğŸ› ï¸ æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

        - **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: React 18
        - **ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°**: CSS3 (ã‚«ã‚¹ã‚¿ãƒ )
        - **ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«**: Create React App
        - **ãƒ‡ãƒ—ãƒ­ã‚¤**: Docker + Nginx

        ## ğŸ“± ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ

        - ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—
        - ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ  
        - ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³

        ## ğŸ¨ UI/UX ç‰¹å¾´

        - ãƒ¢ãƒ€ãƒ³ãªã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ã‚¶ã‚¤ãƒ³
        - ã‚¹ãƒ ãƒ¼ã‚ºãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        - ç›´æ„Ÿçš„ãªæ“ä½œæ€§
        - æ—¥æœ¬èªå¯¾å¿œ

        ---

        **ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ ğŸ¤–**
README_EOF
          
          echo "âœ… Fallback React Todo app created successfully"
        fi

    - name: Setup Google Cloud (if deploying)
      if: contains(github.event.inputs.tech_stack, 'node') || contains(github.event.inputs.tech_stack, 'react')
      uses: google-github-actions/setup-gcloud@v2
      with:
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        
    - name: Build and deploy to Google Cloud Run
      if: contains(github.event.inputs.tech_stack, 'node') || contains(github.event.inputs.tech_stack, 'react')
      run: |
        cd output
        
        # Check if we have a Dockerfile
        if [ -f "Dockerfile" ]; then
          echo "ğŸ³ Building Docker image..."
          
          # Build and push Docker image
          docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/generated-app .
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/generated-app
          
          # Deploy to Cloud Run
          echo "ğŸš€ Deploying to Cloud Run..."
          gcloud run deploy generated-app \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/generated-app \
            --platform managed \
            --region us-central1 \
            --allow-unauthenticated \
            --port 80 \
            --memory 512Mi \
            --cpu 1
            
          # Get deployment URL
          DEPLOY_URL=$(gcloud run services describe generated-app --region=us-central1 --format='value(status.url)')
          echo "âœ… Deployed to: $DEPLOY_URL"
          echo "DEPLOY_URL=$DEPLOY_URL" >> $GITHUB_ENV
        else
          echo "âš ï¸ No Dockerfile found, skipping deployment"
        fi
        
    - name: Commit generated files
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add all generated files
        git add output/
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "âš ï¸ No changes to commit"
        else
          git commit -m "ğŸ¤– Generated ${{ github.event.inputs.project_type }} project with ${{ github.event.inputs.tech_stack }} stack

          Generated by OAuth Standalone Pipeline
          - Project type: ${{ github.event.inputs.project_type }}
          - Tech stack: ${{ github.event.inputs.tech_stack }}
          - Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          git push
          echo "âœ… Changes committed and pushed"
        fi
        
    - name: Create summary
      run: |
        echo "## ğŸš€ Project Generation Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Project Type:** ${{ github.event.inputs.project_type }}" >> $GITHUB_STEP_SUMMARY
        echo "**Tech Stack:** ${{ github.event.inputs.tech_stack }}" >> $GITHUB_STEP_SUMMARY
        echo "**Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ğŸ“ Generated Files:" >> $GITHUB_STEP_SUMMARY
        if [ -d "output" ]; then
          find output/ -type f | head -20 | while read file; do
            echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
          done
          
          FILE_COUNT=$(find output/ -type f | wc -l)
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total files generated:** $FILE_COUNT" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ No output directory found" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸš€ Deployment Status:" >> $GITHUB_STEP_SUMMARY
        if [ -n "$DEPLOY_URL" ]; then
          echo "âœ… **Successfully deployed to Google Cloud Run**" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”— **Live URL:** [$DEPLOY_URL]($DEPLOY_URL)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Deployment was skipped or failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ› ï¸ Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "1. Check the generated files in the \`output/\` directory" >> $GITHUB_STEP_SUMMARY
        echo "2. Review the code quality and functionality" >> $GITHUB_STEP_SUMMARY
        echo "3. Test the deployed application (if deployed)" >> $GITHUB_STEP_SUMMARY
        echo "4. Make any necessary customizations" >> $GITHUB_STEP_SUMMARY
